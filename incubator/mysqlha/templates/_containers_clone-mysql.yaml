- name: clone-mysql
  image: {{ .Values.xtraBackupImage }}
  command:
    - bash
    - "-c"
    - |
      set -ex
      # Skip the clone if data already exists.
      [[ -d /var/lib/mysql/mysql ]] && exit 0
      # Skip the clone on master (ordinal index 0).
      [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
      ordinal=${BASH_REMATCH[1]}
      [[ $ordinal -eq 0 ]] && exit 0
      # Clone data from previous peer.
      ncat --recv-only {{ template "fullname" . }}-$(($ordinal-1)).{{ template "fullname" . }} 3307 | xbstream -x -C /var/lib/mysql
      # Prepare the backup.
      xtrabackup --prepare --user=${MYSQL_REPLICATION_USER} --password=${MYSQL_REPLICATION_PASSWORD} --target-dir=/var/lib/mysql\n
  env:
  - name: MYSQL_REPLICATION_USER
    value: {{ .Values.mysqlReplicationUser }}
  - name: MYSQL_REPLICATION_PASSWORD
    valueFrom:
      secretKeyRef:
        name: {{ template "fullname" . }}
        key: mysql-replication-password
  volumeMounts:
  - name: data
    mountPath: /var/lib/mysql
    subPath: mysql
  - name: conf
    mountPath: /etc/mysql/conf.d